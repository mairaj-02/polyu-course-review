{% extends "base.html" %}

{% block content %}
<div class="row mb-4 animate-on-scroll">
    <div class="col-12">
        <h1 class="mb-0">Admin Panel</h1>
        <p class="text-muted">Manage courses and reviews</p>
    </div>
</div>

<div class="row mb-4 animate-on-scroll">
    <div class="col-md-4 mb-4">
        <div class="stats-card">
            <div class="stats-number">{{ courses|length }}</div>
            <p class="mb-0">Total Courses</p>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="stats-card">
            <div class="stats-number">{{ reviews_count }}</div>
            <p class="mb-0">Total Reviews</p>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="stats-card">
            <div class="stats-number">{{ users_count }}</div>
            <p class="mb-0">Total Users</p>
        </div>
    </div>
</div>

<div class="row mb-4 animate-on-scroll">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Add New Course</h5>
            </div>
            <div class="card-body">
                <form id="add-course-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="code" class="form-label">Course Code</label>
                            <input type="text" class="form-control" id="code" required>
                        </div>
                        <div class="col-md-6">
                            <label for="name" class="form-label">Course Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="department" class="form-label">Department</label>
                            <input type="text" class="form-control" id="department" required>
                        </div>
                        <div class="col-md-6">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" required>
                                <option value="">Select Category</option>
                                <option value="CAR">Cluster Area Requirement (CAR)</option>
                                <option value="Service Learning">Service Learning</option>
                                <option value="Leadership">Leadership</option>
                                <option value="Language">Language and Communication</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="subcategory" class="form-label">Subcategory</label>
                            <input type="text" class="form-control" id="subcategory">
                        </div>
                        <div class="col-md-6">
                            <label for="language_requirement" class="form-label">Language Requirement</label>
                            <select class="form-select" id="language_requirement">
                                <option value="">None</option>
                                <option value="EW/ER">English Reading/Writing</option>
                                <option value="CW/CR">Chinese Reading/Writing</option>
                            </select>
                        </div>
                        
                        <!-- CAR specific fields -->
                        <div class="col-md-6 car-field" style="display: none;">
                            <label for="car_category" class="form-label">CAR Category</label>
                            <select class="form-select" id="car_category">
                                <option value="">Select CAR Category</option>
                                <option value="A">A: Human Nature, relation and development</option>
                                <option value="M">M: Chinese culture and history</option>
                                <option value="N">N: Culture, Organization, society, and globalization</option>
                                <option value="D">D: Science, technology and environment</option>
                            </select>
                        </div>
                        
                        <!-- Service Learning specific fields -->
                        <div class="col-md-6 service-learning-field" style="display: none;">
                            <label for="service_location" class="form-label">Service Location</label>
                            <input type="text" class="form-control" id="service_location">
                        </div>
                        
                        <!-- Leadership specific fields -->
                        <div class="col-md-6 leadership-field" style="display: none;">
                            <label for="leadership_type" class="form-label">Leadership Type</label>
                            <select class="form-select" id="leadership_type">
                                <option value="">Select Leadership Type</option>
                                <option value="Tomorrow's Leaders">Tomorrow's Leaders</option>
                                <option value="Tango">Tango</option>
                            </select>
                        </div>
                        
                        <!-- Language specific fields -->
                        <div class="col-md-6 language-field" style="display: none;">
                            <label for="language_type" class="form-label">Language Type</label>
                            <select class="form-select" id="language_type">
                                <option value="">Select Language Type</option>
                                <option value="English">English</option>
                                <option value="Chinese">Chinese</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Add Course</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 animate-on-scroll">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Change Admin Password</h5>
            </div>
            <div class="card-body">
                <form id="change-password-form">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="current_password" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="current_password" required>
                        </div>
                        <div class="col-md-4">
                            <label for="new_password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new_password" required>
                        </div>
                        <div class="col-md-4">
                            <label for="confirm_password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirm_password" required>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-warning">Change Password</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row animate-on-scroll">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Manage Courses</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Department</th>
                                <th>Reviews</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in courses %}
                            <tr>
                                <td>{{ course.code }}</td>
                                <td>{{ course.name }}</td>
                                <td>{{ course.category }}</td>
                                <td>{{ course.department }}</td>
                                <td>{{ course.reviews.count() }}</td>
                                <td>
                                    <a href="{{ url_for('course_detail', id=course.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger delete-course ms-1" data-id="{{ course.id }}">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show/hide category-specific fields
    const categorySelect = document.getElementById('category');
    const carFields = document.querySelectorAll('.car-field');
    const serviceLearningFields = document.querySelectorAll('.service-learning-field');
    const leadershipFields = document.querySelectorAll('.leadership-field');
    const languageFields = document.querySelectorAll('.language-field');
    
    function toggleFields() {
        const category = categorySelect.value;
        
        // Hide all fields
        carFields.forEach(field => field.style.display = 'none');
        serviceLearningFields.forEach(field => field.style.display = 'none');
        leadershipFields.forEach(field => field.style.display = 'none');
        languageFields.forEach(field => field.style.display = 'none');
        
        // Show relevant fields
        if (category === 'CAR') {
            carFields.forEach(field => field.style.display = 'block');
        } else if (category === 'Service Learning') {
            serviceLearningFields.forEach(field => field.style.display = 'block');
        } else if (category === 'Leadership') {
            leadershipFields.forEach(field => field.style.display = 'block');
        } else if (category === 'Language') {
            languageFields.forEach(field => field.style.display = 'block');
        }
    }
    
    categorySelect.addEventListener('change', toggleFields);
    toggleFields(); // Initial call
    
    // Handle form submission
    const addCourseForm = document.getElementById('add-course-form');
    addCourseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            code: document.getElementById('code').value,
            name: document.getElementById('name').value,
            department: document.getElementById('department').value,
            category: document.getElementById('category').value,
            subcategory: document.getElementById('subcategory').value,
            language_requirement: document.getElementById('language_requirement').value
        };
        
        // Add category-specific fields
        if (formData.category === 'CAR') {
            formData.car_category = document.getElementById('car_category').value;
        } else if (formData.category === 'Service Learning') {
            formData.service_location = document.getElementById('service_location').value;
        } else if (formData.category === 'Leadership') {
            formData.leadership_type = document.getElementById('leadership_type').value;
        } else if (formData.category === 'Language') {
            formData.language_type = document.getElementById('language_type').value;
        }
        
        fetch('/add_course', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Course added successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the course.');
        });
    });
    
    // Handle password change
    const changePasswordForm = document.getElementById('change-password-form');
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }
            
            fetch('/change_admin_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password changed successfully!');
                    document.getElementById('change-password-form').reset();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while changing the password.');
            });
        });
    }
    
    // Handle delete course
    const deleteButtons = document.querySelectorAll('.delete-course');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this course?')) {
                const courseId = this.getAttribute('data-id');
                // In a real application, you would implement a delete endpoint
                alert('Delete functionality would be implemented here.');
            }
        });
    });
});
</script>
{% endblock %}